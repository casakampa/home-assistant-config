- id: 0bb4ce9e-cb8d-41e7-9da7-01a69d280518
  alias: Streaming Radio
  trigger:
    - platform: state
      entity_id: input_boolean.play_streaming_radio
      id: boolean_streaming_radio
    - platform: state
      entity_id: input_select.internet_radio_streams
      id: select_streaming_radio
    - platform: state
      entity_id:
        - input_boolean.play_media_sonos_slaapkamer
        - input_boolean.play_media_sonos_woonkamer
      id: boolean_play_media
    - platform: state
      entity_id: zone.home
      to: "0"
      for:
        minutes: 15
      id: "not_home"
  variables:
    boolean_woonkamer_is_on: "{{ is_state('input_boolean.play_media_sonos_woonkamer', 'on') }}"
    boolean_slaapkamer_is_on: "{{ is_state('input_boolean.play_media_sonos_slaapkamer', 'on') }}"
  action:
    - choose:
        - conditions:
            - or:
                - "{{ trigger.id == 'boolean_streaming_radio' and trigger.to_state.state == 'on' }}"
                - and:
                    - "{{ is_state('input_boolean.play_streaming_radio', 'on') }}"
                    - or:
                        - "{{ trigger.id == 'select_streaming_radio' }}"
                        - "{{ trigger.id == 'boolean_play_media' and trigger.to_state.state == 'on' }}"
          sequence:
            - alias: "Controleer of er groep gemaakt moet worden van de geselecteerde luidspreker(s)"
              if:
                - "{{ boolean_slaapkamer_is_on }}"
                - "{{ boolean_woonkamer_is_on }}"
              then:
                - service: media_player.join
                  target:
                    entity_id: media_player.sonos_woonkamer
                  data:
                    group_members: media_player.sonos_slaapkamer
              else:
                - service: media_player.unjoin
                  target:
                    entity_id: >
                      {{ states.media_player
                        | selectattr('entity_id', 'contains', 'sonos')
                        | map(attribute='entity_id')
                        | list }}
            - alias: "Controleer op welke geselecteerde luidspreker(s) gestreamd moet worden"
              if:
                - or:
                    - "{{ boolean_slaapkamer_is_on }}"
                    - "{{ boolean_woonkamer_is_on }}"
              then:
                - alias: "Start streaming radio op de geselecteerde luidspreker(s)"
                  service: script.turn_on
                  target:
                    entity_id: script.start_streaming_radio
                  data:
                    variables:
                      media_player: >-
                        {%
                        if
                          (
                          boolean_slaapkamer_is_on
                          and
                          boolean_woonkamer_is_on
                          )
                        or
                        boolean_woonkamer_is_on
                        %}
                        media_player.sonos_woonkamer
                        {% elif boolean_slaapkamer_is_on %}
                        media_player.sonos_slaapkamer
                        {% endif %}
              else:
                - stop: "Er is geen luidspreker geselecteerd om op af te spelen. De automatisering stopt hier."
        - conditions:
            - "{{ trigger.to_state.state == 'off' }}"
          sequence:
            - if:
                - "{{ trigger.id == 'boolean_play_media' and trigger.to_state.state == 'off' }}"
                - or:
                    - "{{ boolean_slaapkamer_is_on }}"
                    - "{{ boolean_woonkamer_is_on }}"
              then:
                - alias: "Verwijder deze luidspreker uit de groep van luidsprekers"
                  service: media_player.unjoin
                  target:
                    entity_id: >
                      {{ trigger.entity_id | replace('input_boolean.play_media_', 'media_player.') }}
                - alias: "Stop met streaming naar deze luidspreker"
                  service: media_player.media_stop
                  target:
                    entity_id: >
                      {{ trigger.entity_id | replace('input_boolean.play_media_', 'media_player.') }}
              else:
                - alias: "Stop met streaming naar alle actieve luidsprekers"
                  service: media_player.media_stop
                  target:
                    entity_id: >
                      {{ states.media_player
                        | selectattr('entity_id', 'contains', 'sonos')
                        | selectattr('state', 'eq', 'playing')
                        | map(attribute='entity_id')
                        | list }}
        - conditions:
            - "{{ trigger.id == 'not_home' }}"
          sequence:
            - if:
                - "{{ is_state('input_boolean.play_streaming_radio', 'on') }}"
              then:
                - alias: "Stop met streaming radio"
                  service: input_boolean.turn_off
                  target:
                    entity_id: input_boolean.play_streaming_radio
              else:
                - stop: "Streaming radio was niet actief."
      default:
        - stop: "De automatisering word gestopt, want deze trigger kan nu niet worden uitgevoerd."
