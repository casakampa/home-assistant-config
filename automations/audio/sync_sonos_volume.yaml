- id: bb7d4420-e350-41af-9e1f-4c5e69ce878e
  alias: Sync Sonos Volume
  trigger:
    - platform: state
      entity_id: input_number.sonos_media_volume
      id: ha_volume
    - platform: state
      entity_id: input_boolean.mute_streaming_radio
      id: mute_volume
  mode: restart
  condition:
    - "{{ this.attributes.current == 0 }}"
  action:
    - choose:
        - conditions:
            - "{{ trigger.id == 'mute_volume' }}"
          sequence:
            - alias: "Check of het volume wordt gedempt of dat het dempen wordt opgeheven."
              if:
                - "{{ trigger.to_state.state == 'on' }}"
              then:
                - alias: "Demp actieve luidspreker(s)."
                  service: media_player.volume_mute
                  target:
                    entity_id: >
                      {{ states.media_player
                        | selectattr('entity_id', 'contains', 'sonos')
                        | selectattr('state', 'eq', 'playing')
                        | map(attribute='entity_id')
                        | list }}
                  data:
                    is_volume_muted: true
              else:
                - alias: "Heft demping actieve luidspreker(s) op."
                  service: media_player.volume_mute
                  target:
                    entity_id: >
                      {{ states.media_player
                        | selectattr('entity_id', 'contains', 'sonos')
                        | selectattr('state', 'eq', 'playing')
                        | selectattr('attributes.is_volume_muted', 'eq', True)
                        | map(attribute='entity_id')
                        | list }}
                  data:
                    is_volume_muted: false
        - conditions:
            - "{{ trigger.id == 'ha_volume' }}"
          sequence:
            - alias: "Synchroniseer het Home Assistant volume met de Sonos luidspreker(s)."
              service: media_player.volume_set
              target:
                entity_id: >
                  {{ states.media_player
                    | selectattr('entity_id', 'contains', 'sonos')
                    | selectattr('state', 'eq', 'playing')
                    | map(attribute='entity_id')
                    | list }}
              data:
                volume_level: "{{ min(int(states('input_number.sonos_media_volume'), 80) / 100, 0.8) }}"
