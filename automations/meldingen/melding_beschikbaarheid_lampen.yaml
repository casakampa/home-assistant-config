- id: fe91e5c2-cd20-4dce-833d-ae2b61cac6f6
  alias: "Melding: Beschikbaarheid lampen"
  description: "Stuur een melding wanneer een lamp (on)bereikbaar is"
  trigger:
    - platform: state
      entity_id: binary_sensor.beschikbaarheid_lampen
      attribute: onbereikbaar
      not_from:
        - "unavailable"
        - "unknown"
        - "none"
      not_to:
        - "unavailable"
        - "unknown"
        - "none"
  variables:
    tag: &tag "beschikbaarheid_lampen"
  action:
    - alias: "Controleer wat er moet gebeuren"
      if:
        - "{{ is_state(trigger.entity_id, 'on') }}"
      then:
        - variables:
            bericht: >-
              {% set lampen = states.light | rejectattr('entity_id', 'contains', 'zha') | rejectattr('state', 'in', ['on', 'off']) | map(attribute='name') | list %}
              {% set aantal = lampen | count  %}
              {{'Er' ~ ' ' ~ ('is' if aantal <= 1 else 'zijn') ~ ' ' ~ aantal ~ ' ' ~ 'lamp'  ~ ('' if aantal <= 1 else 'en') ~ ' ' ~ 'onbereikbaar:' ~ ' ' ~ lampen | join(', ') }}
        - alias: "Stuur een notificatie met het aantal onbereikbare lampen"
          service: notify.iphone_12
          data:
            message: "{{ bericht }}"
            data:
              tag: *tag
              push:
                interruption-level: passive
        - service: persistent_notification.create
          data:
            message: "{{ bericht }}"
            notification_id: *tag
      else:
        - variables:
            bericht: "Alle lampen zijn weer bereikbaar"
        - alias: "Stuur een notificatie dat alle lampen bereikbaar zijn"
          service: notify.iphone_12
          data:
            message: "{{ bericht }}"
            data:
              tag: *tag
              push:
                interruption-level: passive
        - service: persistent_notification.create
          data:
            message: "{{ bericht }}"
            notification_id: *tag
