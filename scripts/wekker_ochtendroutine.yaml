wekker_met_ochtendroutine:
  alias: "Wekker met wake-up light en ochtendroutine"
  icon: "mdi:weather-sunset-up"
  description: "Routine voor het wekken van Maarten, tot en met melden dat er vertrokken moet worden om op tijd te zijn op het werk"
  variables:
    tag: &tag "{{ this.entity_id }}"
    slaapkamer: &slaapkamer "light.slaapkamer_zha_group_0x0005"
    # Deze variabele wordt meegestuurd vanuit de automatisering Wekker en ochtendroutine in automations/alarm_clock.yaml
    werklocatie: "{{ werklocatie }}"
    anchors:
      - &bereken_reistijd_huis_naar_werk
        alias: "Bereken reistijd van huis naar vooringestelde werklocatie"
        service: script.turn_on
        target:
          entity_id: "script.calculate_travel_time_zone_{{ werklocatie }}" # Bereken reistijd naar werk op basis van geconfigureerde werklocatie - zie wekker
      - &melding_reistijd_huis_naar_werk
        alias: "Geef een melding van de actuele reistijd naar de vooringestelde werklocatie"
        service: script.turn_on
        target:
          entity_id: "script.update_travel_time_to_aventus_{{ werklocatie }}" # Bereken reistijd naar werk op basis van geconfigureerde werklocatie - zie wekker
        data:
          variables:
            werklocatie: "{{ werklocatie }}"
  sequence:
    - alias: "Start de verlichting zwak en zo warm mogelijk"
      service: light.turn_on
      target:
        entity_id: *slaapkamer
      data:
        brightness_pct: 1
        color_temp: "{{ int(state_attr('light.lamp_slaapkamer_plafond', 'max_mireds'), 454) }}"
    - alias: "Laat de lampen 10 seconden branden, voordat er verder wordt gegaan"
      delay:
        seconds: 10
    - alias: "Simuleer een zonsopkomst met onderstaande instellingen"
      service: light.turn_on
      target:
        entity_id: *slaapkamer
      data:
        transition: "{{ float(states('input_number.wekker_wake_up_tijdsspanne'), 15.0) | multiply(60, 900) - 10 }}" # -10 seconden vanwege de delay
        brightness_pct: "{{ float(states('input_number.wekker_wake_up_lichtsterkte'), 80) }}"
        kelvin: "{{ float(states('input_number.wekker_wake_up_kleurtemperatuur'), 2500) }}"
    - alias: "Laat mij weten dat ik er nu uit zou moeten/kunnen gaan"
      service: notify.iphone_12
      data:
        message: "Tijd om wakker te worden"
        data:
          tag: *tag
          push:
            interruption-level: time-sensitive
    - alias: "Wacht evenlang als dat de verlichting nodig heeft om de juiste helderheid te bereiken, alvorens verder te gaan"
      delay:
        minutes: "{{ float(states('input_number.wekker_wake_up_tijdsspanne'), 15) }}"
    - alias: "Bepaal of de verlichting in de woonkamer en keuken ingeschakeld moet worden"
      service: script.turn_on
      target:
        entity_id: script.controle_daglicht_woonkamer # Controleert of er genoeg daglicht in de woonkamer is, anders wordt de verlichting ingeschakeld
    # Het is zover, je moet eruit
    - service: notify.iphone_12
      data:
        message: "Tijd om uit bed te stappen."
        data:
          push:
            interruption-level: time-sensitive
            sound: "US-EN-Morgan-Freeman-Good-Morning.wav"
          tag: *tag
    - delay:
        minutes: 5
    # Schakel lamp uit
    - service: light.turn_off
      target:
        entity_id: *slaapkamer
    # Controleer of er wordt thuisgewerkt vandaag
    - alias: "Controleer op thuiswerken. Ga door wanneer dit niet zo is, stop anders de automatisering."
      if: "{{ is_state('input_boolean.thuiswerk_status', 'off') }}"
      then:
        # Bereken op de achtergrond de reistijd naar de betreffende werklocatie zodat deze gegevens actueel zijn
        - *bereken_reistijd_huis_naar_werk
        # Eem wachten...
        - delay:
            minutes: 35
        # Stuur een melding van de reistijd naar de werklocatie
        - *melding_reistijd_huis_naar_werk
        # Stuur herinnering
        - service: notify.iphone_12
          data:
            message: "Over 5 minuten moet je vertrekken"
            data:
              push:
                interruption-level: time-sensitive
              tag: *tag
        # Nog even tijdrekken
        - delay:
            minutes: 5
        # Stuur een laatste melding van de reistijd naar werklocatie
        - *melding_reistijd_huis_naar_werk
        # Stuur herinnering
        - service: notify.iphone_12
          data:
            message: "Tijd om te vertrekken!"
            data:
              push:
                interruption-level: time-sensitive
              tag: *tag
        - parallel:
            # Schakel Chromecast uit
            - service: media_player.turn_off
              target:
                entity_id: media_player.woonkamer
            # Schakel lampen uit
            - service: light.turn_off
              target:
                entity_id: light.woonkamer_eethoek_keuken_zha_group_0x0008
      else:
        stop: "De ochtendroutine is gestopt want er wordt thuisgewerkt"

# Dit script wordt geactiveerd door het script wekker_met_ochtendroutine
controle_daglicht_woonkamer:
  alias: "Schakel lichtgroep Woonkamer is, wanneer de wektijd voor de zonsopkomst is"
  icon: "mdi:format-list-checkbox"
  description: "Wanneer het schemert of nacht is volgens de sensor woonkamer, schakel de verlichting in de woonkamer in zodat deze aanstaat wanneer Maarten uit bed komt"
  sequence:
    - alias: "Schakel de verlichting van woonkamer en keuken in bij onvoldoende daglicht"
      if:
        - "{{ is_state('binary_sensor.woonkamer_dag', 'off') }}"
      then:
        - parallel:
            - service: light.turn_on
              target:
                entity_id: light.woonkamer_zha_group_0x0003
              data:
                brightness_pct: 40
                kelvin: 2250
            - service: light.turn_on
              target:
                entity_id: light.keuken_zha_group_0x0002
              data:
                brightness_pct: 25
                kelvin: 2500
      else:
        stop: "Er is voldoende daglicht aanwezig, de verlichting blijft uitgeschakeld."
